name: Data Preprocessing Automation

# Trigger otomatis
on:
  # Auto-trigger saat ada perubahan di toyota_raw/ atau script preprocessing
  push:
    branches:
      - main
    paths:
      - 'toyota_raw/**'
      - 'preprocessing/automate_Muhammad-Wildan.py'
  
  # Masih bisa manual trigger juga
  workflow_dispatch:

jobs:
  preprocess-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Izin untuk push otomatis
    
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # Setup Python
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn
      
      # Jalankan preprocessing
      - name: Run preprocessing automation
        run: |
          cd preprocessing
          python automate_Muhammad-Wildan.py
          echo " Preprocessing selesai!"
      
      # Commit hasil preprocessing otomatis
      - name: Commit and push preprocessed data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add preprocessing/toyota_clean/
          
          # Check jika ada perubahan
          if git diff --staged --quiet; then
            echo "Tidak ada perubahan pada data preprocessing"
          else
            git commit -m " Auto: Update preprocessed dataset [skip ci]"
            git push
            echo " Preprocessed data berhasil di-push!"
          fi
      
      # Upload sebagai artifact (bisa di-download)
      - name: Upload preprocessed data as artifact
        uses: actions/upload-artifact@v4
        with:
          name: toyota-clean-data-${{ github.run_number }}
          path: preprocessing/toyota_clean/toyota_clean.csv
          retention-days: 30
      
      # Summary yang bagus
      - name: Create job summary
        if: always()
        run: |
          echo "##  Preprocessing Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo " **Status**: Preprocessing completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: Data Preprocessing Automation" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Output Files" >> $GITHUB_STEP_SUMMARY
          echo "- \`preprocessing/toyota_clean/toyota_clean.csv\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1.  Preprocessed data telah di-commit ke repository" >> $GITHUB_STEP_SUMMARY
          echo "2.  Artifact tersedia untuk download (30 hari)" >> $GITHUB_STEP_SUMMARY
          echo "3. Ready untuk modeling dengan MLflow!" >> $GITHUB_STEP_SUMMARY